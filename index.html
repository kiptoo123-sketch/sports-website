<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Football Betting Demo - Auto Latest</title>
  <style>
    body { font-family: Arial, sans-serif; padding:20px; background:#f4f4f4; }
    h2 { color: #333; display:flex; justify-content:space-between; align-items:center; }
    .match { border:1px solid #ccc; padding:10px; margin:10px 0; border-radius:5px; background:white; display:flex; align-items:center; flex-wrap: wrap; }
    .match.live { border-color:#e74c3c; background:#ffe6e6; }
    .logo { width:40px; height:40px; margin:0 10px; }
    .teams { flex:1; }
    .odds button { padding:5px 10px; margin:3px; background:#007bff; color:white; border:none; border-radius:3px; cursor:pointer; }
    .odds button:hover { background:#0056b3; }
    .countdown { font-weight:bold; color:#e67e22; }
    #predictions { background:white; padding:10px; border-radius:5px; border:1px solid #ccc; margin-top:10px; }
    .league { font-size:0.9em; color:#555; margin-bottom:5px; }
    button#refresh { padding:5px 10px; cursor:pointer; background:#27ae60; color:white; border:none; border-radius:3px; }
    button#refresh:hover { background:#1e8449; }
  </style>
</head>
<body>

<h2>Live Matches <button id="refresh" onclick="loadMatches()">Refresh</button></h2>
<div id="live">Loading live matches...</div>

<h2>Upcoming Matches</h2>
<div id="upcoming">Loading upcoming matches...</div>

<h2>Finished Matches / Results</h2>
<div id="results">Loading results...</div>

<h2>Your Predictions</h2>
<div id="predictions">You have not made any predictions yet.</div>

<script>
const API_KEY = "50f522f5ff34de0a7224a773578c6509";

// Format UTC date to local readable string
function formatTime(utcDate){
  const dateUTC = new Date(utcDate);
  return dateUTC.toLocaleString("en-KE", {
    timeZone: "Africa/Nairobi",
    hour:"2-digit",
    minute:"2-digit",
    weekday:"short",
    month:"short",
    day:"numeric"
  });
}

// User Predictions
function displayPredictions() {
  const preds = JSON.parse(localStorage.getItem("predictions")||"{}");
  const container = document.getElementById("predictions");
  if(Object.keys(preds).length===0){
    container.innerText = "You have not made any predictions yet.";
  } else {
    container.innerHTML = "";
    for(const [fixtureId, choice] of Object.entries(preds)){
      container.innerHTML += `<div>Match ID ${fixtureId}: <strong>${choice}</strong></div>`;
    }
  }
}

// Save user prediction
function predict(option, fixtureId){
  let predictions = JSON.parse(localStorage.getItem("predictions")||"{}");
  predictions[fixtureId] = option;
  localStorage.setItem("predictions", JSON.stringify(predictions));
  displayPredictions();
}

// Fetch odds for fixture
function fetchOdds(fixtureId){
  fetch(`https://v3.football.api-sports.io/odds?fixture=${fixtureId}`, {
    headers:{ "x-apisports-key": API_KEY }
  }).then(res=>res.json())
    .then(data=>{
      const odds = data.response[0]?.bookmakers[0]?.bets[0]?.values;
      if(odds){
        document.getElementById(`home-${fixtureId}`).innerText = `Home Win ${odds[0].odd}`;
        document.getElementById(`draw-${fixtureId}`).innerText = `Draw ${odds[1].odd}`;
        document.getElementById(`away-${fixtureId}`).innerText = `Away Win ${odds[2].odd}`;
      }
    }).catch(err=>console.warn(`No odds for fixture ${fixtureId}`, err));
}

// Render Match
function renderMatch(container, match, type="upcoming"){
  const fixtureId = match.fixture.id;
  const leagueName = match.league.name;
  const countryName = match.league.country;

  const dateUTC = new Date(match.fixture.date);
  const countdown = () => {
    const now = new Date();
    const diff = dateUTC - now;
    if(diff<=0) return "Kickoff now!";
    const hours = Math.floor(diff/1000/60/60);
    const minutes = Math.floor((diff/1000/60)%60);
    const seconds = Math.floor((diff/1000)%60);
    return `${hours}h ${minutes}m ${seconds}s`;
  }

  const matchDiv = document.createElement("div");
  matchDiv.className = "match";
  if(type==="live") matchDiv.classList.add("live");

  matchDiv.innerHTML = `
    <div class="league"><strong>${leagueName}</strong> (${countryName})</div>
    <img src="${match.teams.home.logo}" class="logo">
    <div class="teams"><strong>${match.teams.home.name}</strong> vs <strong>${match.teams.away.name}</strong></div>
    <img src="${match.teams.away.logo}" class="logo"><br>
    üïí Kickoff: ${formatTime(match.fixture.date)}
    ${type==="upcoming"? '| ‚è± Countdown: <span class="countdown">'+countdown()+'</span>':''}
    ${type==="results"? '| Score: '+match.goals.home+'-'+match.goals.away:''}
    <div class="odds">
      <button id="home-${fixtureId}" onclick="predict('home', ${fixtureId})">Home Win 2.5</button>
      <button id="draw-${fixtureId}" onclick="predict('draw', ${fixtureId})">Draw 3.1</button>
      <button id="away-${fixtureId}" onclick="predict('away', ${fixtureId})">Away Win 2.8</button>
    </div>
  `;

  container.appendChild(matchDiv);

  if(type==="upcoming"){
    const countdownSpan = matchDiv.querySelector(".countdown");
    setInterval(()=>{ countdownSpan.innerText = countdown(); }, 1000);
  }

  fetchOdds(fixtureId);
}

// ------------------ Load Matches ------------------
function loadMatches(){
  displayPredictions();

  // Live matches
  fetch("https://v3.football.api-sports.io/fixtures?live=all", { headers:{ "x-apisports-key": API_KEY } })
  .then(res=>res.json())
  .then(data=>{
    const container = document.getElementById("live");
    container.innerHTML="";
    if(data.response.length===0) container.innerText="No live matches currently.";
    else data.response.forEach(match=>renderMatch(container, match, "live"));
  }).catch(err=>{ document.getElementById("live").innerText="Error loading live matches"; console.error(err); });

  // Upcoming matches (next 10)
  fetch("https://v3.football.api-sports.io/fixtures?next=10", { headers:{ "x-apisports-key": API_KEY } })
  .then(res=>res.json())
  .then(data=>{
    const container = document.getElementById("upcoming");
    container.innerHTML="";
    data.response.forEach(match=>renderMatch(container, match, "upcoming"));
  }).catch(err=>{ document.getElementById("upcoming").innerText="Error loading upcoming matches"; console.error(err); });

  // Finished matches (yesterday)
  const yesterday = new Date();
  yesterday.setDate(yesterday.getDate()-1);
  const yDate = yesterday.toISOString().split("T")[0];
  fetch(`https://v3.football.api-sports.io/fixtures?date=${yDate}`, { headers:{ "x-apisports-key": API_KEY } })
  .then(res=>res.json())
  .then(data=>{
    const container = document.getElementById("results");
    container.innerHTML="";
    if(data.response.length===0) container.innerText="No finished matches for yesterday.";
    else data.response.forEach(match=>renderMatch(container, match, "results"));
  }).catch(err=>{ document.getElementById("results").innerText="Error loading results"; console.error(err); });
}

// Initial load
loadMatches();
</script>

</body>
</html>
