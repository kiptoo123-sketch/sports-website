<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Betika-Style Predictor</title>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; background:#f9f9f9; }
  h1 { text-align:center; }
  button { margin:5px; padding:8px 12px; cursor:pointer; }
  #matches, #leaderboard { margin-top:20px; }
  table { width:100%; border-collapse: collapse; margin-top:10px; }
  th, td { border:1px solid #ccc; padding:8px; text-align:center; }
  th { background:#eee; }
  select { padding:5px; }
</style>
</head>
<body>

<h1>Betika-Style Predictor</h1>

<div id="login-section">
  <button id="login-btn">Login with Google</button>
  <button id="logout-btn" style="display:none;">Logout</button>
</div>

<div id="user-info"></div>

<div id="matches">
  <h2>Matches</h2>
  <table id="matches-table">
    <thead>
      <tr><th>Match</th><th>Prediction</th><th>Action</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div id="leaderboard">
  <h2>Leaderboard</h2>
  <table id="leaderboard-table">
    <thead>
      <tr><th>User</th><th>Points</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.2/firebase-app.js";
  import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.6.2/firebase-auth.js";
  import { getFirestore, collection, addDoc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.6.2/firebase-firestore.js";

  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyDyqTVq8hDjWatJBG4uVgTGaPA6TZ5yA_s",
    authDomain: "betika-style-predictor.firebaseapp.com",
    projectId: "betika-style-predictor",
    storageBucket: "betika-style-predictor.firebasestorage.app",
    messagingSenderId: "1081822274358",
    appId: "1:1081822274358:web:cfd0d79f9d1c6e5fd68997"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const provider = new GoogleAuthProvider();

  // DOM Elements
  const loginBtn = document.getElementById("login-btn");
  const logoutBtn = document.getElementById("logout-btn");
  const userInfo = document.getElementById("user-info");
  const matchesTableBody = document.querySelector("#matches-table tbody");
  const leaderboardBody = document.querySelector("#leaderboard-table tbody");

  let currentUser = null;

  // Fetch live matches from TheSportsDB
  async function loadMatches() {
    try {
      const res = await fetch("https://www.thesportsdb.com/api/v1/json/1/eventsnextleague.php?id=4328");
      const data = await res.json();
      const matches = data.events.map((event, index) => ({
        id: index+1,
        teams: `${event.strHomeTeam} vs ${event.strAwayTeam}`,
        date: event.dateEvent,
        time: event.strTime
      }));
      displayMatches(matches);
    } catch (err) {
      console.error("Error loading matches:", err);
      matchesTableBody.innerHTML = "<tr><td colspan='3'>Failed to load matches.</td></tr>";
    }
  }

  function displayMatches(matches) {
    matchesTableBody.innerHTML = "";
    matches.forEach(match => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${match.teams} <br> <small>${match.date} ${match.time}</small></td>
        <td>
          <select id="pred-${match.id}">
            <option value="">Select</option>
            <option value="Home">Home</option>
            <option value="Draw">Draw</option>
            <option value="Away">Away</option>
          </select>
        </td>
        <td><button onclick="submitPrediction(${match.id}, '${match.teams}')">Predict</button></td>
      `;
      matchesTableBody.appendChild(tr);
    });
  }

  // Submit prediction
  window.submitPrediction = async (matchId, matchName) => {
    if(!currentUser) return alert("Login first!");
    const select = document.getElementById(`pred-${matchId}`);
    const prediction = select.value;
    if(!prediction) return alert("Select a prediction");

    await addDoc(collection(db, "predictions"), {
      user: currentUser.displayName,
      matchId,
      matchName,
      prediction,
      timestamp: Date.now()
    });

    alert("Prediction saved!");
  };

  // Display leaderboard
  function displayLeaderboard(data) {
    leaderboardBody.innerHTML = "";
    data.forEach(item => {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${item.user}</td><td>${item.points}</td>`;
      leaderboardBody.appendChild(tr);
    });
  }

  // Listen to Firestore and update leaderboard
  const q = query(collection(db, "predictions"), orderBy("timestamp", "desc"));
  onSnapshot(q, snapshot => {
    const leaderboardMap = {};
    snapshot.docs.forEach(doc => {
      const data = doc.data();
      leaderboardMap[data.user] = (leaderboardMap[data.user] || 0) + 1;
    });
    const leaderboardData = Object.keys(leaderboardMap).map(u => ({ user:u, points:leaderboardMap[u] }));
    displayLeaderboard(leaderboardData);
  });

  // Login
  loginBtn.onclick = () => signInWithPopup(auth, provider).catch(err => alert(err.message));

  // Logout
  logoutBtn.onclick = () => signOut(auth);

  // Auth state
  onAuthStateChanged(auth, user => {
    currentUser = user;
    if(user){
      loginBtn.style.display = "none";
      logoutBtn.style.display = "inline-block";
      userInfo.innerHTML = `Logged in as <b>${user.displayName}</b>`;
    } else {
      loginBtn.style.display = "inline-block";
      logoutBtn.style.display = "none";
      userInfo.innerHTML = "";
    }
  });

  // Load matches on page load
  loadMatches();

</script>

</body>
</html>
